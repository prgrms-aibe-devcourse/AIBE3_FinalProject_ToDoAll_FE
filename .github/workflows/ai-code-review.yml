name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  issue_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write

env:
  MODEL: gpt-4o-mini          
  MAX_TOKENS: "2000"
  MAX_FILES: "40"
  MAX_LINES: "1800"
  EXCLUDE_GLOBS: |
    **/*.lock
    **/node_modules/**
    **/dist/**
    **/*.png
    **/*.jpg
    **/*.svg
    **/*.gif
    **/*.zip
    **/*.map
    **/*.pdf
    **/*.test.*
    **/*.spec.*
    **/*.snap

jobs:
  review:
    runs-on: ubuntu-latest

    steps:
      - name: Check trigger
        id: gate
        shell: bash
        run: |
          EVENT="${{ github.event_name }}"

          # /ai-review comment only
          if [[ "$EVENT" == "issue_comment" ]]; then
            BODY="${{ github.event.comment.body }}"
            [[ ! "$BODY" =~ ^/ai-review ]] && echo "not_needed=true" >> $GITHUB_OUTPUT && exit 0
          fi
          
          # ignore draft PRs
          if [[ "$EVENT" == "pull_request" && "${{ github.event.pull_request.draft }}" == "true" ]]; then
            echo "not_needed=true" >> $GITHUB_OUTPUT && exit 0
          fi

      - name: Exit if not needed
        if: steps.gate.outputs.not_needed == 'true'
        run: echo "Skip AI review"

      - name: Checkout
        if: steps.gate.outputs.not_needed != 'true'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup SHAs
        id: shas
        if: steps.gate.outputs.not_needed != 'true'
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            BASE="${{ github.event.pull_request.base.sha }}"
            HEAD="${{ github.event.pull_request.head.sha }}"
            PR="${{ github.event.pull_request.number }}"
          else
            PR="${{ github.event.issue.number }}"
            BASE=$(gh api repos/${{ github.repository }}/pulls/$PR --jq .base.sha)
            HEAD=$(gh api repos/${{ github.repository }}/pulls/$PR --jq .head.sha)
          fi
          echo "base=$BASE" >> $GITHUB_OUTPUT
          echo "head=$HEAD" >> $GITHUB_OUTPUT
          echo "pr=$PR" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Filter files
        id: files
        if: steps.gate.outputs.not_needed != 'true'
        run: |
          BASE="${{ steps.shas.outputs.base }}"
          HEAD="${{ steps.shas.outputs.head }}"

          mapfile -t DIFF < <(git diff --name-only "$BASE" "$HEAD")

          FILTERED=()
          for f in "${DIFF[@]}"; do
            SKIP=0
            while IFS= read -r pattern; do
              [[ $f == $pattern ]] && SKIP=1 && break
              [[ $f == */$pattern ]] && SKIP=1 && break
            done <<< "$EXCLUDE_GLOBS"
            (( SKIP == 0 )) && FILTERED+=("$f")
          done

          [[ ${#FILTERED[@]} -gt $MAX_FILES ]] && FILTERED=("${FILTERED[@]:0:$MAX_FILES}")
          printf "%s\n" "${FILTERED[@]}" > files.txt
          echo "list=$(jq -R -s -c 'split(\"\\n\")[:-1]' files.txt)" >> $GITHUB_OUTPUT

      - name: Create patch JSON
        id: diff
        if: steps.gate.outputs.not_needed != 'true'
        run: |
          BASE="${{ steps.shas.outputs.base }}"
          HEAD="${{ steps.shas.outputs.head }}"

          LINES=$(git diff --unified=0 "$BASE" "$HEAD" | grep -E '^(\+|\-)' | wc -l)
          if (( LINES > MAX_LINES )); then
            jq -n --argjson files '${{ steps.files.outputs.list }}' \
              '{oversize:true, files:$files}' > diff.json
            echo "oversize=true" >> $GITHUB_OUTPUT
          else
            git diff "$BASE" "$HEAD" > diff.patch
            jq -n --rawfile patch diff.patch \
              --arg base "$BASE" --arg head "$HEAD" \
              '{oversize:false, base:$base, head:$head, patch:$patch}' > diff.json
            echo "oversize=false" >> $GITHUB_OUTPUT
          fi

      - name: Build prompt
        run: |
          PR=${{ steps.shas.outputs.pr }}

          cat << 'EOF' > system.txt
You are a senior front-end reviewer for React + TypeScript projects.
Focus on:
- Component structure & state mgmt (Zustand, React Query)
- Hooks correctness & cleanup
- Accessibility (a11y)
- Tailwind consistency
- Performance (re-renders, memo, useCallback)
- Type-safety & proper TS generics
EOF

          {
            echo "<PR>"
            gh api repos/${{ github.repository }}/pulls/$PR --jq '{title:.title, author:.user.login, body:.body}'
            echo "</PR>"
            echo "<DIFF>"
            cat diff.json
            echo "</DIFF>"
          } > user.txt
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Call LLM
        id: llm
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          [[ -z "$OPENAI_API_KEY" ]] && echo "::error::Missing OPENAI_API_KEY" && exit 1

          RESP=$(jq -n \
            --arg model "$MODEL" \
            --arg sys "$(cat system.txt)" \
            --arg usr "$(cat user.txt)" \
            --argjson mt "$MAX_TOKENS" \
            '{
              model: $model,
              temperature: 0.2,
              max_tokens: $mt,
              messages: [
                {role:"system", content:$sys},
                {role:"user", content:$usr}
              ]
            }' | curl -sS https://api.openai.com/v1/chat/completions \
              -H "Authorization: Bearer '"$OPENAI_API_KEY"'" \
              -H "Content-Type: application/json" \
              -d @-)

          CONTENT=$(jq -r '.choices[0].message.content // "No feedback"' <<< "$RESP")

          echo "content<<EOF" >> $GITHUB_OUTPUT
          echo "$CONTENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Comment PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR=${{ steps.shas.outputs.pr }}
          BODY="${{ steps.llm.outputs.content }}"

          cat << 'EOF' > comment.txt
### ðŸ¤– AI Code Review
<details><summary>Expand</summary>

EOF

          printf "%s\n" "$BODY" >> comment.txt

          cat << 'EOF' >> comment.txt

</details>
EOF

          gh api repos/${{ github.repository }}/issues/$PR/comments \
            -f body="$(cat comment.txt)"
