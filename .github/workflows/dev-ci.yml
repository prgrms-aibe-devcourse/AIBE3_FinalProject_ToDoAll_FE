on:
  push:
    branches: [develop]
  pull_request:
    branches: [develop]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run lint (optional)
        run: npm run lint

      - name: Check .gitignore - Find changed files
        id: diff
        shell: bash
        run: |
          set -euo pipefail
          
          EVENT="${{ github.event_name }}"
          
          if [[ "$EVENT" == "pull_request" ]]; then
            BASE="${{ github.event.pull_request.base.sha }}"
            HEAD="${{ github.event.pull_request.head.sha }}"
          else
            # push 이벤트일 때: 'before' → 'after(=github.sha)'
            BASE="${{ github.event.before }}"
            HEAD="${{ github.sha }}"
          fi
          
          # act 환경에서 PR SHA가 비거나 merge-base 불가하면 develop 기준으로 강제 3-dot
          if [[ "${ACT:-}" == "true" ]]; then
            if [[ -z "${BASE:-}" || -z "${HEAD:-}" ]] || ! git merge-base "$BASE" "$HEAD" >/dev/null 2>&1; then
              git fetch --no-tags --prune origin +refs/heads/develop:refs/remotes/origin/develop
              BASE=$(git merge-base HEAD origin/develop)
              HEAD=HEAD
            fi
          fi
          
          # 값이 비었거나 merge-base 불가하면 2-dot로 폴백 
          if [[ -n "${BASE:-}" && -n "${HEAD:-}" ]] && git merge-base "$BASE" "$HEAD" >/dev/null 2>&1; then 
            git diff --name-only "$BASE...$HEAD" > changed.txt 
          else 
            git diff --name-only "${BASE:-HEAD^}" "${HEAD:-HEAD}" > changed.txt
            echo "BASE 혹은 HEAD가 비어있거나 공통 조상이 없어 2-dot 비교로 대체하였습니다."
          fi
          
          echo "count=$(wc -l < changed.txt | tr -d ' ')" >> "$GITHUB_OUTPUT"
    
      - name: Check .gitignore - Show result
        run: |
          echo "Changed count: ${{ steps.diff.outputs.count }}"
          cat changed.txt || true
          
          # --no-index: 트래킹된 파일이라도 .gitignore 규칙에 매치되면 감지
          if git check-ignore --no-index -v --stdin < changed.txt; then
            echo "::error .gitignore violation:: PR에 .gitignore의 파일이 포함되어 있습니다."
            exit 1
          fi

      - name: Run unit tests (optional)
        run: npm run test
        continue-on-error: true

      - name: Create dummy .env
        run: |
          echo "VITE_API_URL=https://dummy.api" > .env

      - name: Run build
        run: npm run build